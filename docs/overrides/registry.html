{% extends "main.html" %}

{% block styles %}
  {{ super() }}
  <style>
    #sections-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      grid-auto-rows: minmax(max-content, 1fr);
      gap: 1rem;
      list-style: none;
      margin: 1rem 0;
    }

    #sections-list li {
      display: flex;
      flex-direction: column;
      height: 100%;
      margin: 0;
      padding: 0.5rem;
      border-bottom: 1px solid var(--md-default-fg-color--lightest);
      border-radius: 0.1rem;
      cursor: pointer;
      color: var(--md-default-fg-color--light);
      transition: all 0.2s ease-in-out;
    }

    #sections-list li:hover,
    #sections-list li:focus {
      background-color: var(--md-default-fg-color--lightest);
      color: var(--md-typeset-a-color);
    }

    #sections-list li em {
      font-weight: lighter;
      font-size: smaller;
      color: var(--md-typeset-a-color);
    }
  </style>
{% endblock %}

<!-- Search-related JavaScript -->
{% block scripts %}
  {{ super() }}

  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js"></script>
  <script>
    const list = document.querySelector('#sections-list');
    const input = document.querySelector('#sections-search');
    const registryType = input ? input.getAttribute('data-registry') : null;

    if (list && input) {
      const registry = registryType
        ? fetch(`/registry/${registryType}.json`)
            .then(res => res.json())
            .then(registry => registry.sections)
        : Promise.all([
            fetch('/registry/internal.json').then(res => res.json()),
            fetch('/registry/external.json').then(res => res.json()),
          ])
            .then(([internal, external]) => ([
              ...internal.sections,
              ...external.sections
            ]));

      registry.then(sections => {
        debugger
        list.innerHTML = sections
          .sort((a, b) => a.name.localeCompare(b.name))
          .map(item => `
            <a href="${item.url}">
              <li>
                <strong>
                  ${item.name}
                  ${item.internal ? '<em>internal</em>' : ''}
                </strong>
                ${item.description}
              </li>
            </a>
          `)
          .join('');
      });

      input.addEventListener('keyup', _.debounce(e => {
        const query = e.target.value.toLowerCase().trim();

        Array.from(list.children).forEach(item => {
          if (item.innerText.toLowerCase().includes(query)) {
            item.style.display = '';
          } else {
            item.style.display = 'none';
          }
        })
      }, 300));
    }
  </script>
{% endblock %}
